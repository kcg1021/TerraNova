<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.terranova.mapper.UserMapper">

    <!-- 결과 맵 정의 -->
    <resultMap id="userResultMap" type="com.terranova.domain.user.User">
        <id property="id" column="user_id"/>
        <result property="username" column="username"/>
        <result property="email" column="email"/>
        <result property="name" column="name"/>
        <result property="phone" column="phone"/>
        <result property="role" column="role"/>
        <result property="enabled" column="enabled"/>
        <result property="createdAt" column="created_at"/>
        <result property="createdBy" column="created_by"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="updatedBy" column="updated_by"/>
        <result property="deleted" column="deleted"/>
    </resultMap>

    <!-- 복잡한 조건으로 사용자 검색 (동적 쿼리) -->
    <select id="searchUsers" parameterType="map" resultMap="userResultMap">
        SELECT
            user_id, username, email, name, phone, role, enabled,
            created_at, created_by, updated_at, updated_by, deleted
        FROM users
        WHERE deleted = false
        <if test="username != null and username != ''">
            AND username LIKE CONCAT('%', #{username}, '%')
        </if>
        <if test="email != null and email != ''">
            AND email LIKE CONCAT('%', #{email}, '%')
        </if>
        <if test="role != null and role != ''">
            AND role = #{role}
        </if>
        <if test="enabled != null">
            AND enabled = #{enabled}
        </if>
        <if test="startDate != null">
            AND created_at >= #{startDate}
        </if>
        <if test="endDate != null">
            AND created_at <= #{endDate}
        </if>
        ORDER BY created_at DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
        <if test="offset != null">
            OFFSET #{offset}
        </if>
    </select>

    <!-- 사용자 통계 조회 (집계 쿼리) -->
    <select id="getUserStatistics" resultType="map">
        SELECT
            COUNT(*) as total_users,
            COUNT(CASE WHEN enabled = true THEN 1 END) as active_users,
            COUNT(CASE WHEN enabled = false THEN 1 END) as inactive_users,
            COUNT(CASE WHEN role = 'ADMIN' THEN 1 END) as admin_count,
            COUNT(CASE WHEN role = 'USER' THEN 1 END) as user_count,
            COUNT(CASE WHEN created_at >= CURRENT_DATE - INTERVAL '30 days' THEN 1 END) as new_users_last_month
        FROM users
        WHERE deleted = false
    </select>

    <!-- 역할별 사용자 수 조회 -->
    <select id="countUsersByRole" resultType="map">
        SELECT
            role,
            COUNT(*) as count,
            COUNT(CASE WHEN enabled = true THEN 1 END) as active_count
        FROM users
        WHERE deleted = false
        GROUP BY role
        ORDER BY count DESC
    </select>

    <!-- 최근 가입한 사용자 조회 -->
    <select id="findRecentUsers" resultMap="userResultMap">
        SELECT
            user_id, username, email, name, phone, role, enabled,
            created_at, created_by, updated_at, updated_by, deleted
        FROM users
        WHERE deleted = false
        ORDER BY created_at DESC
        LIMIT #{limit}
    </select>

    <!-- 비활성화된 사용자 목록 조회 -->
    <select id="findInactiveUsers" resultMap="userResultMap">
        SELECT
            user_id, username, email, name, phone, role, enabled,
            created_at, created_by, updated_at, updated_by, deleted
        FROM users
        WHERE deleted = false
          AND enabled = false
          AND updated_at <= CURRENT_TIMESTAMP - INTERVAL '#{days} days'
        ORDER BY updated_at ASC
    </select>

</mapper>
